---
layout: single
title: 不要轻信AI：拒绝采样方法的证明
date: 2025-2-7
author: listenzcc
categories: AI Rejection-Sampling
toc: true
---

最近在啃DeepSeek的文章，其中提到了拒绝采样（Rejection Sampling）的LLM训练方法，于是顺手把这个方法丢给AI想看看如何证明。
但DeepSeek和ChatGPT给出的证明都不令人满意，因为它们都试图从联合概率的角度证明之，但RS问题实际是条件概率问题。
于是在给出提示词“不应该是联合概率，而应该是条件概率。”后，DeepSeek给出的正确的分析结果。
我觉得这个过程很值得记录下来，说明现阶段还是不能完全依赖AI进行数学上的证明。

---

[toc]

## 核心思路

拒绝采样是一种从复杂分布中生成样本的常用方法，尤其适用于难以直接采样的分布。
拒绝采样的目标是让**被接受的样本**服从目标分布 $ p(x) $。我们需要证明：
$$
p_{\text{accepted}}(x) = p(x)
$$
即，在已知样本被接受的条件下，$ x $ 的概率分布等于目标分布。
在拒绝采样的证明中，更严谨的方式应通过条件概率来分析接受样本的分布，而非直接对联合概率积分。

## 证明步骤

1. 定义变量和条件概率：
   - 候选样本 $ x $ 从提议分布 $ q(x) $ 中生成。
   - 均匀随机数 $ u \sim U(0, 1) $，用于决定是否接受 $ x $。
   - 接受条件为：$ u \leq \frac{p(x)}{M \cdot q(x)} $，其中 $ M $ 是满足 $ p(x) \leq M \cdot q(x) $ 的常数。

2. 计算接受概率：
   - 单个样本 $ x $ 被接受的概率（条件概率）：
     $$
     P(\text{接受} \mid x) = \frac{p(x)}{M \cdot q(x)}.
     $$
   - 总体接受概率（全概率公式）：
     $$
     P(\text{接受}) = \int P(\text{接受} \mid x) q(x) \, dx = \int \frac{p(x)}{M \cdot q(x)} \cdot q(x) \, dx = \frac{1}{M}.
     $$

3. 应用贝叶斯定理：
   - 被接受样本的分布（后验概率）：
     $$
     p_{\text{accepted}}(x) = P(x \mid \text{接受}) = \frac{P(\text{接受} \mid x) \cdot q(x)}{P(\text{接受})}.
     $$
   - 代入步骤 2 的结果：
     $$
     p_{\text{accepted}}(x) = \frac{\frac{p(x)}{M \cdot q(x)} \cdot q(x)}{\frac{1}{M}} = p(x).
     $$

## 关键点总结

1. 条件概率的桥梁作用：
   - 通过定义 $ P(\text{接受} \mid x) $，将提议分布 $ q(x) $ 与目标分布 $ p(x) $ 联系起来。
   - 贝叶斯定理将条件概率 $ P(\text{接受} \mid x) $ 转换为后验分布 $ P(x \mid \text{接受}) $。

2. 常数 $ M $ 的作用：
   - $ M $ 需满足 $ p(x) \leq M \cdot q(x) $，确保接受概率 $ \alpha = \frac{p(x)}{M \cdot q(x)} \leq 1 $。
   - 总体接受概率 $ P(\text{接受}) = \frac{1}{M} $，因此 $ M $ 越大，采样效率越低。

## 拒绝采样的直观理解

- 提议分布 $ q(x) $ 的作用：覆盖目标分布 $ p(x) $，但可能“过于松散”（需通过 $ M $ 调整）。
- 接受概率 $ \alpha $ 的作用：压低 $ q(x) $ 的高估区域，使最终样本分布与 $ p(x) $ 一致。
- 几何解释：在 $ q(x) $ 曲线下生成随机点 $ (x, u \cdot M \cdot q(x)) $，若该点位于 $ p(x) $ 曲线下方则接受。

## 附注：拒绝采样的效率

- 采样效率：接受概率 $ P(\text{接受}) = \frac{1}{M} $，因此需尽可能选择接近目标分布 $ p(x) $ 的 $ q(x) $，并最小化 $ M $。
- 局限性：当 $ p(x) $ 与 $ q(x) $ 形状差异大时，$ M $ 会很大，导致计算效率低下。

## 附注：有问题的证明

### 问题描述

假设我们有一个目标分布 $ p(x) $，但无法直接从 $ p(x) $ 中采样。我们有一个提议分布 $ q(x) $，且满足以下条件：

1. 可以从 $ q(x) $ 中直接采样。
2. 存在一个常数 $ M > 0 $，使得 $ p(x) \leq M \cdot q(x) $ 对所有 $ x $ 成立。

我们的目标是从 $ p(x) $ 中生成样本。

### 拒绝采样步骤

1. 从提议分布 $ q(x) $ 中采样：生成一个候选样本 $ x \sim q(x) $。
2. 计算接受概率：
   $$
   \alpha = \frac{p(x)}{M \cdot q(x)}
   $$
   其中 $ \alpha $ 是接受概率，$ M $ 是保证 $ p(x) \leq M \cdot q(x) $ 的常数。
3. 接受或拒绝样本：
   - 以概率 $ \alpha $ 接受样本 $ x $。
   - 否则拒绝样本，并重复步骤 1。

### 证明拒绝采样的正确性

我们需要证明，通过拒绝采样生成的样本 $ x $ 服从目标分布 $ p(x) $。

1. 联合概率分布：
   设 $ x $ 是从 $ q(x) $ 中采样的候选样本，$ u $ 是从均匀分布 $ U(0, 1) $ 中生成的随机数。样本 $ x $ 被接受的条件是：
   $$
   u \leq \frac{p(x)}{M \cdot q(x)}
   $$
   因此，联合概率分布为：
   $$
   p(x, u) = q(x) \cdot \mathbb{I}\left(u \leq \frac{p(x)}{M \cdot q(x)}\right)
   $$
   其中 $ \mathbb{I}(\cdot) $ 是指示函数。

2. 边缘分布：
   我们对 $ u $ 积分，得到 $ x $ 的边缘分布：
   $$
   p(x) = \int_0^1 p(x, u) \, du = q(x) \cdot \int_0^{\frac{p(x)}{M \cdot q(x)}} du = q(x) \cdot \frac{p(x)}{M \cdot q(x)} = \frac{p(x)}{M}
   $$
   这一步表明，$ x $ 的边缘分布与 $ p(x) $ 成正比。

3. 归一化：
   由于 $ p(x) $ 是一个概率分布，需要满足归一化条件：
   $$
   \int p(x) \, dx = 1
   $$
   因此，我们得到：
   $$
   \int \frac{p(x)}{M} \, dx = \frac{1}{M} \int p(x) \, dx = \frac{1}{M}
   $$
   为了保证归一化，我们需要将 $ p(x) $ 乘以 $ M $，即：
   $$
   p(x) = M \cdot \frac{p(x)}{M}
   $$
   这表明拒绝采样生成的样本 $ x $ 服从目标分布 $ p(x) $。

### 总结

拒绝采样的核心思想是通过一个容易采样的提议分布 $ q(x) $ 和一个接受概率 $ \alpha $ 来生成服从目标分布 $ p(x) $ 的样本。通过上述证明，我们可以看到拒绝采样的正确性和有效性。
